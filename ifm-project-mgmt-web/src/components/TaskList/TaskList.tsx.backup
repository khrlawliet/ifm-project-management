import { useState, useEffect } from 'react';
import {
  Box,
  Paper,
  Typography,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  TablePagination,
  Chip,
  FormControl,
  InputLabel,
  Select,
  MenuItem,
  Grid,
  Button,
  Dialog,
  DialogTitle,
  DialogContent,
  DialogActions,
  TextField,
  IconButton,
} from '@mui/material';
import { Add as AddIcon, Edit as EditIcon, Delete as DeleteIcon } from '@mui/icons-material';
import type { SelectChangeEvent } from '@mui/material/Select';
import { DatePicker } from '@mui/x-date-pickers/DatePicker';
import { LocalizationProvider } from '@mui/x-date-pickers/LocalizationProvider';
import { AdapterDayjs } from '@mui/x-date-pickers/AdapterDayjs';
import dayjs, { Dayjs } from 'dayjs';
import { taskApi, projectApi } from '../../services/api';
import type { Task, TaskFilters, Project, CreateTaskRequest } from '../../types';
import LoadingSpinner from '../common/LoadingSpinner';
import ErrorMessage from '../common/ErrorMessage';

interface TaskListProps {
  onTaskChanged?: () => void;
}

const TaskList = ({ onTaskChanged }: TaskListProps) => {
  const [tasks, setTasks] = useState<Task[]>([]);
  const [projects, setProjects] = useState<Project[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [page, setPage] = useState(0);
  const [rowsPerPage, setRowsPerPage] = useState(10);
  const [totalElements, setTotalElements] = useState(0);

  const [filters, setFilters] = useState<TaskFilters>({
    sortBy: 'dueDate',
  });
  const [startDate, setStartDate] = useState<Dayjs | null>(null);
  const [endDate, setEndDate] = useState<Dayjs | null>(null);
  const [priorityFilter, setPriorityFilter] = useState<number | ''>('');

  // Task dialog state
  const [dialogOpen, setDialogOpen] = useState(false);
  const [editingTask, setEditingTask] = useState<Task | null>(null);
  const [formData, setFormData] = useState<CreateTaskRequest>({
    name: '',
    priority: 1,
    dueDate: '',
    assignee: '',
    projectId: 0,
  });
  const [formDueDate, setFormDueDate] = useState<Dayjs | null>(dayjs().add(1, 'day'));
  const [formError, setFormError] = useState<string | null>(null);
  const [formLoading, setFormLoading] = useState(false);

  useEffect(() => {
    loadProjects();
  }, []);

  useEffect(() => {
    loadTasks();
  }, [page, rowsPerPage, filters, priorityFilter]);

  const loadProjects = async () => {
    try {
      const data = await projectApi.getProjects();
      setProjects(data);
      if (data.length > 0) {
        setFormData((prev) => ({ ...prev, projectId: data[0].id }));
      }
    } catch (err) {
      console.error('Failed to load projects', err);
    }
  };

  const loadTasks = async () => {
    try {
      setLoading(true);
      setError(null);

      let response;
      if (filters.projectId) {
        // Use project-specific endpoint: GET /api/projects/{projectId}/tasks
        response = await taskApi.getTasks(filters.projectId, {
          startDate: filters.startDate,
          endDate: filters.endDate,
          sortBy: filters.sortBy,
          page,
          size: rowsPerPage,
        });
      } else {
        // Use general endpoint: GET /api/tasks
        response = await taskApi.getAllTasks({
          ...filters,
          page,
          size: rowsPerPage,
        });
      }

      // Filter by priority on client-side if priority filter is active
      let filteredTasks = response.content;
      if (priorityFilter) {
        filteredTasks = filteredTasks.filter(task => task.priority === Number(priorityFilter));
      }

      setTasks(filteredTasks);
      setTotalElements(priorityFilter ? filteredTasks.length : response.totalElements);
    } catch (err: any) {
      setError(err.response?.data?.message || 'Failed to load tasks');
    } finally {
      setLoading(false);
    }
  };

  const handleChangePage = (event: unknown, newPage: number) => {
    setPage(newPage);
  };

  const handleChangeRowsPerPage = (event: React.ChangeEvent<HTMLInputElement>) => {
    setRowsPerPage(parseInt(event.target.value, 10));
    setPage(0);
  };

  const handleFilterChange = (e: SelectChangeEvent) => {
    const { name, value } = e.target;
    setFilters((prev) => ({
      ...prev,
      [name]: name === 'projectId' ? (value ? Number(value) : undefined) : value,
      sortBy: 'dueDate', // Always sort by due date
    }));
    setPage(0);
  };

  const handleStartDateChange = (date: Dayjs | null) => {
    setStartDate(date);
    setFilters((prev) => ({
      ...prev,
      startDate: date ? date.format('YYYY-MM-DD') : undefined,
    }));
    setPage(0);
  };

  const handleEndDateChange = (date: Dayjs | null) => {
    setEndDate(date);
    setFilters((prev) => ({
      ...prev,
      endDate: date ? date.format('YYYY-MM-DD') : undefined,
    }));
    setPage(0);
  };

  const handlePriorityFilterChange = (e: SelectChangeEvent) => {
    setPriorityFilter(e.target.value as number | '');
    setPage(0);
  };

  // Task dialog handlers
  const handleOpenCreateDialog = () => {
    setEditingTask(null);
    setFormData({
      name: '',
      priority: 1,
      dueDate: '',
      assignee: '',
      projectId: projects.length > 0 ? projects[0].id : 0,
    });
    setFormDueDate(dayjs().add(1, 'day'));
    setFormError(null);
    setDialogOpen(true);
  };

  const handleOpenEditDialog = (task: Task) => {
    setEditingTask(task);
    setFormData({
      name: task.name,
      priority: task.priority,
      dueDate: task.dueDate,
      assignee: task.assignee,
      projectId: task.projectId,
    });
    setFormDueDate(dayjs(task.dueDate));
    setFormError(null);
    setDialogOpen(true);
  };

  const handleCloseDialog = () => {
    setDialogOpen(false);
    setEditingTask(null);
    setFormError(null);
  };

  const handleFormChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement> | SelectChangeEvent
  ) => {
    const { name, value } = e.target;
    setFormData((prev) => ({
      ...prev,
      [name]: name === 'priority' || name === 'projectId' ? Number(value) : value,
    }));
  };

  const handleFormDateChange = (date: Dayjs | null) => {
    setFormDueDate(date);
    if (date) {
      setFormData((prev) => ({
        ...prev,
        dueDate: date.format('YYYY-MM-DD'),
      }));
    }
  };

  const handleSubmit = async () => {
    setFormLoading(true);
    setFormError(null);

    try {
      if (editingTask) {
        // Update existing task
        await taskApi.updateTask(editingTask.id!, formData);
      } else {
        // Create new task
        await taskApi.createTask(formData);
      }
      handleCloseDialog();
      loadTasks();
      if (onTaskChanged) {
        onTaskChanged();
      }
    } catch (err: any) {
      setFormError(err.response?.data?.message || `Failed to ${editingTask ? 'update' : 'create'} task`);
    } finally {
      setFormLoading(false);
    }
  };

  const handleDelete = async (taskId: number) => {
    if (!window.confirm('Are you sure you want to delete this task?')) {
      return;
    }

    try {
      await taskApi.deleteTask(taskId);
      loadTasks();
      if (onTaskChanged) {
        onTaskChanged();
      }
    } catch (err: any) {
      setError(err.response?.data?.message || 'Failed to delete task');
    }
  };

  const getPriorityColor = (priority: number): 'error' | 'warning' | 'info' | 'success' => {
    if (priority === 1) return 'error';
    if (priority === 2) return 'warning';
    if (priority <= 3) return 'info';
    return 'success';
  };

  const getStatusColor = (status: string): 'default' | 'primary' | 'success' | 'warning' => {
    if (status === 'COMPLETED') return 'success';
    if (status === 'IN_PROGRESS') return 'primary';
    if (status === 'PENDING') return 'warning';
    return 'default';
  };

  const getDueDateColor = (task: Task): string => {
    const today = dayjs().startOf('day');
    const due = dayjs(task.dueDate).startOf('day');
    const diffDays = due.diff(today, 'day');

    // If task is completed, always show green
    if (task.status === 'COMPLETED') {
      return '#e8f5e9'; // light green background
    }

    // For IN_PROGRESS or PENDING tasks
    if (diffDays < 0) {
      // Past due - red
      return '#ffebee'; // light red background
    } else if (diffDays >= 0 && diffDays <= 2) {
      // Due today or 1-2 days - orange
      return '#fff3e0'; // light orange background
    } else {
      // 3+ days - blue
      return '#e3f2fd'; // light blue background
    }
  };

  const getDueDateTextColor = (task: Task): string => {
    const today = dayjs().startOf('day');
    const due = dayjs(task.dueDate).startOf('day');
    const diffDays = due.diff(today, 'day');

    // If task is completed, always show green text
    if (task.status === 'COMPLETED') {
      return '#2e7d32'; // dark green text
    }

    // For IN_PROGRESS or PENDING tasks
    if (diffDays < 0) {
      return '#c62828'; // dark red text
    } else if (diffDays >= 0 && diffDays <= 2) {
      return '#e65100'; // dark orange text
    } else {
      return '#1565c0'; // dark blue text
    }
  };

  if (loading && tasks.length === 0) {
    return <LoadingSpinner message="Loading tasks..." />;
  }

  return (
    <>
      <Paper elevation={3} sx={{ p: 3 }}>
        <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
          <Typography variant="h5">Tasks</Typography>
          <Button
            variant="contained"
            color="primary"
            startIcon={<AddIcon />}
            onClick={handleOpenCreateDialog}
          >
            Create Task
          </Button>
        </Box>

        {/* Filters */}
        <Box mb={3}>
          <Grid container spacing={2}>
            <Grid item xs={12} sm={6} md={4}>
              <FormControl fullWidth>
                <InputLabel shrink>Project</InputLabel>
                <Select
                  name="projectId"
                  value={filters.projectId?.toString() || ''}
                  onChange={handleFilterChange}
                  label="Project"
                  displayEmpty
                  notched
                  renderValue={(selected) => {
                    if (!selected || selected === '') {
                      return 'All Projects';
                    }
                    const project = projects.find(p => p.id === Number(selected));
                    return project ? project.name : 'All Projects';
                  }}
                >
                  <MenuItem value="">All Projects</MenuItem>
                  {projects.map((project) => (
                    <MenuItem key={project.id} value={project.id}>
                      {project.name}
                    </MenuItem>
                  ))}
                </Select>
              </FormControl>
              <Typography variant="caption" color="text.secondary" sx={{ mt: 0.5, display: 'block' }}>
                Which project's tasks to show
              </Typography>
            </Grid>

            <Grid item xs={12} sm={6} md={4}>
              <FormControl fullWidth>
                <InputLabel shrink>Priority</InputLabel>
                <Select
                  value={priorityFilter.toString()}
                  onChange={handlePriorityFilterChange}
                  label="Priority"
                  displayEmpty
                  notched
                  renderValue={(selected) => {
                    if (!selected || selected === '') {
                      return 'All Priorities';
                    }
                    return `Priority ${selected}`;
                  }}
                >
                  <MenuItem value="">All Priorities</MenuItem>
                  <MenuItem value="1">Priority 1 (Highest)</MenuItem>
                  <MenuItem value="2">Priority 2</MenuItem>
                  <MenuItem value="3">Priority 3</MenuItem>
                  <MenuItem value="4">Priority 4</MenuItem>
                  <MenuItem value="5">Priority 5 (Lowest)</MenuItem>
                </Select>
              </FormControl>
              <Typography variant="caption" color="text.secondary" sx={{ mt: 0.5, display: 'block' }}>
                Filter by specific priority level
              </Typography>
            </Grid>

            <Grid item xs={12} sm={12} md={4}>
              <Box sx={{ border: '1px solid', borderColor: 'divider', borderRadius: 1, p: 2 }}>
                <Typography variant="subtitle2" fontWeight="medium" mb={2}>
                  Due Date
                </Typography>
                <Grid container spacing={2}>
                  <Grid item xs={12} sm={6}>
                    <LocalizationProvider dateAdapter={AdapterDayjs}>
                      <DatePicker
                        label="Date From"
                        value={startDate}
                        onChange={handleStartDateChange}
                        slotProps={{ textField: { fullWidth: true, size: 'small' } }}
                      />
                    </LocalizationProvider>
                  </Grid>
                  <Grid item xs={12} sm={6}>
                    <LocalizationProvider dateAdapter={AdapterDayjs}>
                      <DatePicker
                        label="Date To"
                        value={endDate}
                        onChange={handleEndDateChange}
                        slotProps={{ textField: { fullWidth: true, size: 'small' } }}
                      />
                    </LocalizationProvider>
                  </Grid>
                </Grid>
              </Box>
              <Typography variant="caption" color="text.secondary" sx={{ mt: 0.5, display: 'block' }}>
                Filter tasks by due date range
              </Typography>
            </Grid>
          </Grid>
        </Box>

        {error && <ErrorMessage message={error} onRetry={loadTasks} />}

        {/* Task Table */}
        <TableContainer>
          <Table>
            <TableHead>
              <TableRow>
                <TableCell>Task Name</TableCell>
                <TableCell>Project</TableCell>
                <TableCell>Assignee</TableCell>
                <TableCell align="center">Priority</TableCell>
                <TableCell align="center">Status</TableCell>
                <TableCell>Due Date</TableCell>
                <TableCell align="center">Actions</TableCell>
              </TableRow>
            </TableHead>
            <TableBody>
              {loading ? (
                <TableRow>
                  <TableCell colSpan={7}>
                    <LoadingSpinner message="Loading tasks..." />
                  </TableCell>
                </TableRow>
              ) : tasks.length === 0 ? (
                <TableRow>
                  <TableCell colSpan={7} align="center">
                    <Typography variant="body2" color="text.secondary">
                      No tasks found
                    </Typography>
                  </TableCell>
                </TableRow>
              ) : (
                tasks.map((task) => (
                  <TableRow key={task.id} hover>
                    <TableCell>{task.name}</TableCell>
                    <TableCell>{task.projectName || `Project ${task.projectId}`}</TableCell>
                    <TableCell>{task.assignee}</TableCell>
                    <TableCell align="center">
                      <Chip
                        label={task.priority}
                        color={getPriorityColor(task.priority)}
                        size="small"
                      />
                    </TableCell>
                    <TableCell align="center">
                      <Chip
                        label={task.status}
                        color={getStatusColor(task.status)}
                        size="small"
                        variant="outlined"
                      />
                    </TableCell>
                    <TableCell
                      sx={{
                        backgroundColor: getDueDateColor(task),
                        fontWeight: 'medium',
                        color: getDueDateTextColor(task),
                      }}
                    >
                      {dayjs(task.dueDate).format('MMM DD, YYYY')}
                    </TableCell>
                    <TableCell align="center">
                      <IconButton
                        size="small"
                        color="primary"
                        onClick={() => handleOpenEditDialog(task)}
                        title="Edit task"
                      >
                        <EditIcon fontSize="small" />
                      </IconButton>
                      <IconButton
                        size="small"
                        color="error"
                        onClick={() => handleDelete(task.id!)}
                        title="Delete task"
                      >
                        <DeleteIcon fontSize="small" />
                      </IconButton>
                    </TableCell>
                  </TableRow>
                ))
              )}
            </TableBody>
          </Table>
        </TableContainer>

        <TablePagination
          component="div"
          count={totalElements}
          page={page}
          onPageChange={handleChangePage}
          rowsPerPage={rowsPerPage}
          onRowsPerPageChange={handleChangeRowsPerPage}
          rowsPerPageOptions={[5, 10, 25, 50]}
        />
      </Paper>

      {/* Create/Edit Task Dialog */}
      <Dialog open={dialogOpen} onClose={handleCloseDialog} maxWidth="sm" fullWidth>
        <DialogTitle>{editingTask ? 'Edit Task' : 'Create New Task'}</DialogTitle>
        <DialogContent>
          {formError && (
            <Box mb={2}>
              <Typography color="error">{formError}</Typography>
            </Box>
          )}
          <Box component="form" noValidate sx={{ mt: 2 }}>
            <Grid container spacing={2}>
              <Grid item xs={12}>
                <TextField
                  fullWidth
                  required
                  label="Task Name"
                  name="name"
                  value={formData.name}
                  onChange={handleFormChange}
                  disabled={formLoading}
                />
              </Grid>

              <Grid item xs={12}>
                <TextField
                  fullWidth
                  required
                  label="Assignee"
                  name="assignee"
                  value={formData.assignee}
                  onChange={handleFormChange}
                  disabled={formLoading}
                />
              </Grid>

              <Grid item xs={12} sm={6}>
                <FormControl fullWidth required>
                  <InputLabel>Project</InputLabel>
                  <Select
                    name="projectId"
                    value={formData.projectId.toString()}
                    onChange={handleFormChange}
                    label="Project"
                    disabled={formLoading}
                  >
                    {projects.map((project) => (
                      <MenuItem key={project.id} value={project.id}>
                        {project.name}
                      </MenuItem>
                    ))}
                  </Select>
                </FormControl>
              </Grid>

              <Grid item xs={12} sm={6}>
                <FormControl fullWidth required>
                  <InputLabel>Priority</InputLabel>
                  <Select
                    name="priority"
                    value={formData.priority.toString()}
                    onChange={handleFormChange}
                    label="Priority"
                    disabled={formLoading}
                  >
                    {[1, 2, 3, 4, 5].map((p) => (
                      <MenuItem key={p} value={p}>
                        {p} {p === 1 && '(Highest)'} {p === 5 && '(Lowest)'}
                      </MenuItem>
                    ))}
                  </Select>
                </FormControl>
              </Grid>

              <Grid item xs={12}>
                <LocalizationProvider dateAdapter={AdapterDayjs}>
                  <DatePicker
                    label="Due Date"
                    value={formDueDate}
                    onChange={handleFormDateChange}
                    disabled={formLoading}
                    slotProps={{
                      textField: {
                        fullWidth: true,
                        required: true,
                      },
                    }}
                  />
                </LocalizationProvider>
              </Grid>
            </Grid>
          </Box>
        </DialogContent>
        <DialogActions>
          <Button onClick={handleCloseDialog} disabled={formLoading}>
            Cancel
          </Button>
          <Button
            onClick={handleSubmit}
            variant="contained"
            disabled={formLoading || !formData.name || !formData.assignee || !formData.dueDate}
          >
            {formLoading ? 'Saving...' : editingTask ? 'Update' : 'Create'}
          </Button>
        </DialogActions>
      </Dialog>
    </>
  );
};

export default TaskList;
